var purposeCodes=[{name:"SOCIAL INFRASTRUCTURE AND SERVICES",code:100,children:[{name:"EDUCATION",code:110,children:[{name:"Education, combinations of purposes",code:11E3},{name:"Education, level unspecified",code:111,children:[{name:"Education, level unspecified, combinations of purposes",code:11100},{name:"Education, level unspecified, purpose unspecified or does not fit under any other applicable codes",code:11105},{name:"Education policy and administrative management",code:11110},{name:"Education facilities and training",
code:11120},{name:"Teacher training",code:11130},{name:"Educational research",code:11182}]},{name:"Basic education",code:112,children:[{name:"Primary education",code:11220},{name:"Basic life skills for youth and adults ",code:11230},{name:"Early childhood education",code:11240}]},{name:"Secondary education",code:113,children:[{name:"Secondary education",code:11320},{name:"Vocational training",code:11330}]},{name:"Post-secondary education",code:114,children:[{name:"Higher education",code:11420},{name:"Advanced technical and managerial training",
code:11430}]}]},{name:"HEALTH",code:120,children:[{name:"Health, combination of general, basic, and population policy/reproductive health purposes",code:12E3},{name:"Health, purpose unspecified or does not fit under any other applicable codes",code:12005},{name:"Health, general",code:121,children:[{name:"Health, general, combinations of activities",code:12100},{name:"Health, general, purpose unspecified or does not fit under any other applicable codes",code:12105},{name:"Health policy and administrative management",
code:12110},{name:"Medical education/training",code:12181},{name:"Medical research",code:12182},{name:"Medical services",code:12191}]},{name:"Basic health",code:122,children:[{name:"Basic health care",code:12220},{name:"Basic health infrastructure",code:12230},{name:"Basic nutrition",code:12240},{name:"Infectious & Parasitic disease control",code:12250},{name:"Health education",code:12261},{name:"Health personnel development",code:12281}]}]},{name:"POPULATION POLICIES/ PROGRAMMES AND REPRODUCTIVE HEALTH",
code:130,children:[{name:"Population policies/ programmes and reproductive health, combinations of activities",code:13E3},{name:"Population policies/ programmes and reproductive health, purpose unspecified or does not fit under any other applicable codes",code:13005},{name:"Population policy and administrative management",code:13010},{name:"Reproductive health care",code:13020},{name:"Family planning",code:13030},{name:"STD control including HIV/AIDS",code:13040},{name:"Personnel development for population and reproductive health",
code:13081}]},{name:"WATER SUPPLY AND SANITATION",code:140,children:[{name:"Water Supply and Sanitation, combination of purposes",code:14E3},{name:"Water Supply and Sanitation, purpose unspecified or does not fit under any other applicable codes",code:14005},{name:"Water resources policy and administrative management",code:14010},{name:"Water resources protection",code:14015},{name:"Water supply and sanitation - large systems",code:14020},{name:"Basic drinking water supply and basic sanitation",code:14030},
{name:"River development",code:14040},{name:"Waste management/disposal",code:14050},{name:"Education and training in water supply and sanitation ",code:14081},{name:"Water Research",code:14082}]},{name:"GOVERNMENT AND CIVIL SOCIETY",code:150,children:[{name:"Government and civil society, combination of activities",code:15E3},{name:"Government and civil society, general",code:151,children:[{name:"Government and civil society, general, combination of activities",code:15100},{name:"Government and civil society, purpose unspecified or does not fit under any other applicable codes",
code:15105},{name:"Economic and development policy/planning",code:15110},{name:"Public sector financial management",code:15120},{name:"Legal and judicial development",code:15130},{name:"Government administration ",code:15140},{name:"Strengthening civil society",code:15150}]},{name:"Conflict prevention and resolution, peace and security",code:152,children:[{name:"Conflict prevention and resolution, peace and security, combinations of activities",code:15200},{name:"Conflict prevention and resolution, peace and security, purpose unspecified or does not fit under any other applicable codes",
code:15205},{name:"Security system management and reform",code:15210},{name:"Civilian peace-building, conflict prevention and resolution",code:15220},{name:"Post-conflict peace-building (UN)",code:15230},{name:"Reintegration and SALW control",code:15240},{name:"Land mine clearance",code:15250},{name:"Child soldiers (Prevention and demobilisation) ",code:15261}]}]},{name:"OTHER SOCIAL INFRASTRUCTURE AND SERVICES",code:160,children:[{name:"Social/ welfare services",code:16010},{name:"Employment policy and administrative management",
code:16020},{name:"Housing policy and administrative management",code:16030},{name:"Multisector aid for social services ",code:16050},{name:"Other social infrastructure and services, education and training",code:16081}]}]},{name:"ECONOMIC INFRASTRUCTURE AND SERVICES",code:200,children:[{name:"TRANSPORT AND STORAGE",code:210,children:[{name:"Transport and Storage, combination of purposes",code:21E3},{name:"Transport and Storage, purpose unspecified or does not fit under any other applicable codes",
code:21005},{name:"Transport policy and administrative management",code:21010},{name:"Road transport",code:21020},{name:"Rail transport",code:21030},{name:"Water transport",code:21040},{name:"Air transport",code:21050},{name:"Storage",code:21061},{name:"Education and training in transport and storage",code:21081}]},{name:"COMMUNICATIONS",code:220,children:[{name:"Communications, combinations of activities",code:22E3},{name:"Communications, purpose unspecified or does not fit under any other applicable codes",
code:22005},{name:"Communications policy and administrative management",code:22010},{name:"Telecommunications",code:22020},{name:"Radio/television/print media",code:22030},{name:"Information and communication technology (ICT)",code:22040},{name:"Communications, education and training.",code:22081}]},{name:"ENERGY GENERATION AND SUPPLY",code:230,children:[{name:"Energy generation and supply, combinations of activities",code:23E3},{name:"Energy generation and supply, purpose unspecified or does not fit under any other applicable codes",
code:23005},{name:"Energy policy and administrative management",code:23010},{name:"Power generation/non-renewable sources ",code:23020},{name:"Power generation/renewable sources ",code:23030},{name:"Electrical transmission/ distribution",code:23040},{name:"Gas distribution",code:23050},{name:"Petroleum distribution and storage",code:23055},{name:"Energy education/training",code:23081},{name:"Energy research",code:23082}]},{name:"BANKING AND FINANCIAL SERVICES",code:240,children:[{name:"Banking and financial services, combinations of activities",
code:24E3},{name:"Banking and financial services, purpose unspecified or does not fit under any other applicable codes",code:24005},{name:"Financial policy and administrative management",code:24010},{name:"Monetary institutions",code:24020},{name:"Formal sector financial intermediaries",code:24030},{name:"Informal/semi-formal financial intermediaries",code:24040},{name:"Education/training in banking and financial services",code:24081}]},{name:"BUSINESS AND OTHER SERVICES",code:250,children:[{name:"Business support services and institutions",
code:25010},{name:"Privatisation",code:25020},{name:"Business education and training",code:25081}]}]},{name:"PRODUCTION SECTORS",code:300,children:[{name:"AGRICULTURE, FORESTRY, FISHING",code:310,children:[{name:"Agriculture, combination of purposes in Agriculture, Forestry, Fishing",code:31E3},{name:"Agriculture",code:311,children:[{name:"Agriculture, combinations of purposes in Agriculture, Agro-industry, Agribusiness",code:31100},{name:"Agriculture, purpose unspecified or does not fit under any other applicable codes",
code:31105},{name:"Agricultural policy and administrative management",code:31110},{name:"Agricultural development",code:31120},{name:"Agricultural land resources",code:31130},{name:"Agricultural water resources",code:31140},{name:"Agricultural inputs",code:31150},{name:"Agricultural education/training",code:31181},{name:"Agricultural research ",code:31182},{name:"Agricultural services, purpose",code:31191}]},{name:"Forestry",code:312,children:[{name:"Forestry, purpose unspecified or does not fit under any other applicable codes",
code:31205},{name:"Forestry policy and administrative management",code:31210},{name:"Forestry development",code:31220},{name:"Forestry education/training",code:31281},{name:"Forestry research",code:31282},{name:"Forestry services",code:31291}]},{name:"Fishing",code:313,children:[{name:"Fishing, combination of activities",code:31300},{name:"Fishing, purpose unspecified or does not fit under any other applicable codes",code:31305},{name:"Fishing policy and administrative management",code:31310},{name:"Fishery development",
code:31320},{name:"Fishing Development",code:31330},{name:"Fishery education/training",code:31381},{name:"Fishery research",code:31382},{name:"Fishery services",code:31391}]}]},{name:"INDUSTRY, MINING, CONSTRUCTION",code:320,children:[{name:"Industry, combination of purposes Industry, Mining and Construction",code:32E3},{name:"Industry",code:321,children:[{name:"Industry, purpose unspecified (includes manufacturing of goods not specified below) or does not fit under any other applicable codes",code:32105},
{name:"Industrial policy and administrative management",code:32110},{name:"Industrial development",code:32120},{name:"Small and medium-sized enterprises (SME) development",code:32130},{name:"Cottage industries and handicraft",code:32140},{name:"Industry education and training",code:32181},{name:"Technological research and development",code:32182},{name:"Industry services",code:32191}]}]},{name:"Mineral resources and mining",code:322,children:[{name:"Mineral resources and mining, combination of purposes",
code:32200},{name:"Mineral resources and mining, purpose unspecified or does not fit under any other applicable codes",code:32205},{name:"Mineral/mining policy and administrative management",code:32210},{name:"Mineral/Metal prospection and exploration",code:32220},{name:"Mining Education / Training",code:32281}]},{name:"Construction",code:323,children:[{name:"Construction policy and administrative management",code:32310}]},{name:"TRADE AND TOURISM",code:330,children:[{name:"Trade policy and regulations",
code:331,children:[{name:"Trade policy and regulations, combination of purposes",code:33100},{name:"Trade policy and regulations, purpose unspecified (includes trade and trade promotion activities) or does not fit under any other applicable codes",code:33105},{name:"Trade policy and administrative management",code:33110},{name:"Trade facilitation",code:33120},{name:"Regional trade agreements (RTAs)",code:33130},{name:"Multilateral trade negotiations",code:33140},{name:"Trade education/training",code:33181}]},
{name:"Tourism",code:332,children:[{name:"Tourism policy and administrative management",code:33210}]}]}]},{name:"MULTISECTOR/CROSS-CUTTING",code:400,children:[{name:"GENERAL ENVIRONMENTAL PROTECTION",code:410,children:[{name:"General environmental protection, combinations of purposes",code:41E3},{name:"General environmental protection, purpose unspecified (includes miscellaneous conservation and protection measures not mentioned below) or does not fit under any other applicable codes",code:41005},
{name:"Environmental policy and administrative management",code:41010},{name:"Biosphere protection",code:41020},{name:"Bio-diversity",code:41030},{name:"Site preservation",code:41040},{name:"Flood prevention/control",code:41050},{name:"Environmental education/ training",code:41081},{name:"Environmental research",code:41082}]},{name:"WOMEN",code:420,children:[{name:"Women in development",code:42010}]},{name:"OTHER",code:430,children:[{name:"Multisector aid",code:43010},{name:"Urban development and management",
code:43030},{name:"Rural development",code:43040},{name:"Non-agricultural alternative development",code:43050},{name:"Multisector education/training",code:43081},{name:"Research/scientific institutions",code:43082}]}]},{name:"COMMODITY AID AND GENERAL PROGRAMME ASSISTANCE",code:500,children:[{name:"GENERAL BUDGET SUPPORT",code:510,children:[{name:"General budget support",code:51010}]},{name:"DEVELOPMENT AID/FOOD SECURITY ASSISTANCE",code:520,children:[{name:"Food aid/Food security programmes",code:52010}]},
{name:"OTHER COMMODITY ASSISTANCE",code:530,children:[{name:"Import support (capital goods)",code:53030},{name:"Import support (commodities)",code:53040},{name:"Export Support",code:53050}]}]},{name:"ACTION RELATING TO DEBT",code:600,children:[{name:"Action relating to debt",code:60010},{name:"Debt forgiveness ",code:60020},{name:"Relief of multilateral debt",code:60030},{name:"Rescheduling and refinancing",code:60040}]},{name:"HUMANITARIAN AID",code:700,children:[{name:"Emergency Assistance and Reconstruction, combinations of purposes",
code:70000},{name:"EMERGENCY RESPONSE",code:720,children:[{name:"Emergency Response, combination of purposes",code:72E3},{name:"Material relief assistance and services",code:72010},{name:"Emergency health services/support",code:72020},{name:"Water and sanitation services/support",code:72030},{name:"Emergency food aid",code:72040},{name:"Relief co-ordination; protection and support services",code:72050}]},{name:"RECONSTRUCTION RELIEF",code:730,children:[{name:"Reconstruction relief and rehabilitation",
code:73010}]},{name:"DISASTER PREVENTION AND PREPAREDNESS",code:740,children:[{name:"Disaster prevention and preparedness",code:74010}]}]},{name:"OTHER",code:900,children:[{name:"ADMINISTRATIVE COSTS OF DONORS",code:910,children:[{name:"Administrative costs",code:91010}]},{name:"SUPPORT TO NON- GOVERNMENTAL ORGANISATIONS (NGOs) AND GOVERNMENT ORGANIZATIONS",code:920,children:[{name:"Support to non-governmental organizations and government organizations, combination of purposes",code:92E3},{name:"Support to non-governmental organizations and government organizations, purpose unspecified or does not fit under any other applicable codes",
code:92005},{name:"Support to national NGOs",code:92010},{name:"Support to international NGOs",code:92020},{name:"Support to local and regional NGOs",code:92030}]},{name:"Refugees in donor countries",code:930,children:[{name:"Refugees in Donor Countries",code:93010}]},{name:"UNALLOCATED/  UNSPECIFIED",code:998,children:[{name:"Sectors not specified",code:99810},{name:"Promotion of development awareness",code:99820}]}]}];

var  j=1,
    w = 840,
    h = w,
    r = w / 2,
    x = d3.scale.linear().range([0, 2 * Math.PI]),
    y = d3.scale.pow().exponent(1.5).domain([0,1]).range([1, r]),
    p = 5,
    c = d3.scale.linear().range(['#ddd', 'red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'])
    .domain([0, 1, 250/6, 2*(250/6), 3*(250/6),4*(250/6),5*(250/6), 6*(250/6), ]),
    duration = 500,
    minWedge = .075;
    minWedgeText = Math.PI * .5;
    w+=400;

    

function revColor (c) {
  if (c==0) {return '#ddd'}
  else if (c>230&&c<=255) {
    newColor = d3.scale.linear().range(['#eee','#777','#eee']).domain([231,232, 244])
  }
  else if (c>217&&c<=230) {
    newColor = d3.scale.linear().range(['indigo','violet']).domain([218,  230])
  }
  else if (c>212&&c<=217) {
    newColor = d3.scale.linear().range(['darkblue','#253cb7']).domain([213, 217])
  }
  else if (c>203&&c<=212) {
    newColor = d3.scale.linear().range(['royalblue', '#253cb7','royalblue']).domain([204,205, 212])
  }
  else if (c>183&&c<=203) {
    newColor = d3.scale.linear().range(['green','#80c000']).domain([184,203])
  }
  else if (c>123&&c<=183) {
    newColor = d3.scale.linear().range(['yellow','#90c000','yellow']).domain([124,125, 183])
  }
    else if (c>81&&c<=123) {
    newColor = d3.scale.linear().range(['orange','yellow','orange']).domain([82, 83, 123])
  }
  else if (c>0&&c<=81) {
    newColor = d3.scale.linear().range(['red','orange', 'red']).domain([1,2, 81])
  }
  return newColor(c);
}

var vis = d3.select("#chart")
    .append("svg")
        .attr("width", w + p * 2)
        .attr("height", h + p * 2)
  .append("g")
    .attr("transform", "translate(" + (r + p) + "," + (r + p) + ")");   

var partition = d3.layout.partition()
    .sort(null)
    .value(function(d) { return 6 - d.depth; });
    
var nodes = partition.nodes({children: purposeCodes})
    ;

var arc = d3.svg.arc()
    .startAngle(function(d,i) {return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
    .innerRadius(function(d,i) {return Math.max(0, d.y ? y(d.y) : 0);})
    .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

var path = vis.selectAll("path").data(nodes);
  path.enter().append("path")
      .attr("id", function(d, i) { return "path-" + i; })
      .attr("class", "wedge")
      .attr("d", arc)
      .attr("fill-rule", "evenodd")
      .style("fill", function(d, i) {return revColor(i);})
      .style("stroke", "#000")
      .style("stroke-weight", .5)
      .style("cursor", "pointer")
      .on("click", click)
      .on("mouseover", mOver)
      .on("mouseout", function (){$(".ttp").hide('slow', function() {$(".ttp").remove();})})
  .append('ttp')
    .text(function(d, i) {return d.code + ': '+d.name });

var text = vis.selectAll("text").data(nodes);
  var textEnter = text.enter().append("text")
  .attr("id", function(d, i) { return "text-" + i; })
      //.style("visibility", function(d) {return (Math.abs(x(d.dx))>minWedgeText) ? 'visible' : 'hidden'})
      .attr("text-anchor", function(d) {
        return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
      })
      .attr("dy", ".2em")
      .attr("transform", function(d) {
        var angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
            rotate = angle;
        return "rotate(" + rotate + ")translate(" + (y(d.y) + p) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
      })
      .on("click", click)
      .style("cursor", "pointer")
  //.append('title')
  //    .text(function(d,i) {return i});
  
  textEnter.append("tspan")
      .attr('class', 'code')
      .style("visibility", function(d) {return (Math.abs(x(d.dx))>minWedge) ? 'visible' : 'hidden'})
      .attr("x", 0)
      .text(function(d) { return d.depth ? d.code: ""; });
      
function multiline (d) {
d.nameArray = [d.name.split(/([-\/| ])+/)];
        //console.log(d)
        a = [];
        for (o=0;o<d.nameArray[0].length;o++){
          
          if ((a.toString().length+
            d.nameArray[0][o].toString().length)<13){
          a.push(d.nameArray[0][o])
          }
          else if (d.nameArray[0][o].length>=13){
          d.nameArray.push(a.join(" "));
          d.nameArray.push(d.nameArray[0][o]);
          a=[];
          }
          else {o--;
          d.nameArray.push(a.join(" "));
          a=[];}
}
d.nameArray.push(a.join(" ")+'');
}

   textEnter.append("tspan")
      .attr('class','name')
      .style("visibility", 'hidden')
      .attr("x", 0)
      .attr("y",20)
      .text(function(d) {
        if (d.depth)
        {multiline(d);
        return d.nameArray[1];}
        else {return "";}
        });
   textEnter.append("tspan")
      .attr('class','name')
      .style("visibility", 'hidden')
      .attr("x", 0)
      .attr("y",40)
      .text(function(d) {return d.depth ? d.nameArray[2] : "" });
   textEnter.append("tspan")
      .attr('class','name')
      .style("visibility",'hidden')
      .attr("x", 0)
      .attr("y",60)
      .text(function(d) {return d.depth ? d.nameArray[3] : ''});
      
function click(d) {
    //clearInterval(rpt);
    //clearInterval(cyc);
    
    path.transition()
      .duration(duration)
      .attrTween("d", arcTween(d));
    text
      .transition().duration(duration)
      .attrTween("text-anchor", function(d) {
        return function() {
          return x(d.x + d.dx / 2) > Math.PI ? "end" : "start";
        };
      })
      .attrTween("transform", function(d) {
        return function() {
          var angle = x(d.x + d.dx / 2) * 180 / Math.PI - 90,
              rotate = angle;
          return "rotate(" + rotate + ")translate(" + (y(d.y) + p) + ")rotate(" + (angle > 90 ? -180 : 0) + ")";
        };})
;

console.log(this)

window.setTimeout (function(){
 
  text.selectAll('.code')
    .style("visibility", function(e,i) {
      //console.log(e.code + ', x(e.dx): '+ x(e.dx)); console.log(e);
        if (isParentOf(d, e) && Math.abs(x(e.dx))>minWedge){ return 'visible';}
        else {return 'hidden';}
        })
  ;
  text.selectAll('.name')
    .style("visibility", function (e,i) {
    if (Math.abs(x(e.dx))>minWedgeText && isParentOf(d,e)) {
      return 'visible';
    }
    else {return 'hidden';}
  })

  }, (duration+25))
  }
  
function arcTween(d) {
  var my = maxY(d),
      mx = maxX(d),
      xd = d3.interpolate(x.domain(), [d.x, mx]),
      //xr = d3.interpolate(x.range(), [d.x ? 2 * Math.PI : 0, 2 * Math.PI])
      yd = d3.interpolate(y.domain(), [d.y, my]),
      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, r]);
  return function(d) {
    return function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
  };
}

function maxY(d) {
  return d.children ? Math.max.apply(Math, d.children.map(maxY)) : d.y + d.dy;
}

function maxX(d) {
  return d.children ? Math.max.apply(Math, d.children.map(maxX)) : d.x + d.dx;
}

function isParentOf(p, c) {
  if (p === c) return true;
  if (p.children) {
    return p.children.some(function(d) {
      return isParentOf(d, c);
    });
  }
  return false;
}


function mOver () {
    ttp = $(this).children().text()
    mouse = d3.mouse(this)
  tooltip = vis.selectAll('.ttp')
      .data([ttp])
      .enter().append('g')
        .attr('class', 'ttp')
        .attr('background', '#ff0033')
        ;
  
  xAnchor = mouse[0],
  yAnchor = mouse[1]-20;
  
  tooltip.append('text')
      .attr('id', 'ttpText')
      .text(String)
      .attr("x", xAnchor )
      .attr("y", yAnchor)
      .attr("text-anchor", "start")
      .attr("background", "#f01040")

  tWidth = d3.selectAll('#ttpText').node().getComputedTextLength()
  
  tooltip.insert('rect','#ttpText')
      .attr('width', tWidth +20 )
      .attr('height', '1.3em')
      .attr('x', xAnchor-10)
      .attr('y', yAnchor - 16)
      .style('fill', 'hsla(360,0%,100%, .8)')
      .style('stroke', '#000')
      .style('stroke-weight', '1px')
    //console.log(ttp)  
      }

$('#path-0').children().text('All')
$('#text-213, #text-214, #text-215, #text-216, #text-217').css('fill', '#ddd')